<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>AH Wonders Game</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-purple-100 to-blue-100 min-h-screen flex items-center justify-center">

<div id="root"></div>

<script type="text/babel">

const firebaseConfig = {
  databaseURL: "https://ah-numbergame-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function App() {

  const [screen, setScreen] = React.useState("home");
  const [room, setRoom] = React.useState("");
  const [player, setPlayer] = React.useState(null);
  const [name, setName] = React.useState("");
  const [secret, setSecret] = React.useState("");
  const [guess, setGuess] = React.useState("");
  const [gameData, setGameData] = React.useState(null);
  const [soundPlayed, setSoundPlayed] = React.useState(false);

  const winSound = React.useRef(new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"));
  const loseSound = React.useRef(new Audio("https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg"));

  // Listen room updates
  React.useEffect(() => {
    if (!room) return;

    const roomRef = db.ref("rooms/" + room);

    roomRef.on("value", snap => {
      const data = snap.val();
      setGameData(data);

      if (data?.winner && !soundPlayed) {
        if (data.winner === player) {
          winSound.current.play();
        } else {
          loseSound.current.play();
        }
        setSoundPlayed(true);
      }
    });

    return () => roomRef.off();
  }, [room, player, soundPlayed]);

  function createRoom() {
    const roomId = Math.floor(1000 + Math.random() * 9000).toString();
    db.ref("rooms/" + roomId).set({
      player1: name,
      player2: null,
      secret1: null,
      secret2: null,
      guesses: [],
      turn: 1,
      winner: null,
      score1: 0,
      score2: 0
    });
    setRoom(roomId);
    setPlayer(1);
    setScreen("secret");
  }

  function joinRoom() {
    const ref = db.ref("rooms/" + room);
    ref.once("value", snap => {
      if (snap.exists()) {
        ref.update({ player2: name });
        setPlayer(2);
        setScreen("secret");
      } else {
        alert("Room not found");
      }
    });
  }

  function submitSecret() {
    if (new Set(secret).size !== secret.length) {
      alert("Duplicate number not allowed");
      return;
    }

    db.ref("rooms/" + room).update({
      ["secret" + player]: secret
    });

    setScreen("waiting");
  }

  function calculateResult(secretNum, guessNum) {
    let correctPos = 0;
    let correctNum = 0;

    for (let i = 0; i < 4; i++) {
      if (guessNum[i] === secretNum[i]) correctPos++;
      if (secretNum.includes(guessNum[i])) correctNum++;
    }

    return { correctPos, correctNum };
  }

  function makeGuess() {

    if (new Set(guess).size !== guess.length) {
      alert("Duplicate number not allowed");
      return;
    }

    const opponentSecret = player === 1 ? gameData.secret2 : gameData.secret1;
    const result = calculateResult(opponentSecret, guess);

    const guessScore =
      (result.correctPos * 25) +
      ((result.correctNum - result.correctPos) * 10);

    const updatedGuesses = [
      ...gameData.guesses,
      {
        player,
        guess,
        ...result
      }
    ];

    db.ref("rooms/" + room).update({
      guesses: updatedGuesses,
      turn: result.correctPos === 4 ? null : (player === 1 ? 2 : 1),
      winner: result.correctPos === 4 ? player : null,
      ["score" + player]: guessScore
    });

    setGuess("");
  }

  function leaveRoom() {
    setScreen("home");
    setRoom("");
    setPlayer(null);
    setGameData(null);
    setSoundPlayed(false);
  }

  // UI START

  return (
    <div className="bg-white p-8 rounded-2xl shadow-xl w-[600px]">

      <h1 className="text-3xl font-extrabold text-center mb-6 text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-600">
        AH Wonders Game
      </h1>

      {screen === "home" && (
        <>
          <input
            className="border p-2 w-full mb-3 rounded"
            placeholder="Enter Your Name"
            onChange={e => setName(e.target.value)}
          />
          <button className="bg-purple-600 text-white px-4 py-2 rounded w-full mb-2"
            onClick={createRoom}>Create Room</button>

          <input
            className="border p-2 w-full mb-2 rounded"
            placeholder="Enter Room Number"
            onChange={e => setRoom(e.target.value)}
          />
          <button className="bg-blue-600 text-white px-4 py-2 rounded w-full"
            onClick={joinRoom}>Join Room</button>
        </>
      )}

      {screen === "secret" && (
        <>
          <div className="mb-4 text-center font-semibold">
            Room Number: {room}
          </div>

          <input
            maxLength="4"
            className="border p-2 w-full mb-3 rounded"
            placeholder="Set 4-digit secret number"
            onChange={e => setSecret(e.target.value)}
          />
          <button className="bg-green-600 text-white px-4 py-2 rounded w-full"
            onClick={submitSecret}>Submit Secret</button>
        </>
      )}

      {screen === "waiting" && (
        <div className="text-center">
          Waiting for opponent...
          {gameData?.secret1 && gameData?.secret2 && setScreen("game")}
        </div>
      )}

      {screen === "game" && gameData && (
        <>
          {/* Top Bar */}
          <div className="flex justify-between mb-6">

            <div>
              <div className="text-sm text-gray-500">Your Secret</div>
              <div className="text-xl font-bold text-purple-700">
                {player === 1 ? gameData.secret1 : gameData.secret2}
              </div>
            </div>

            <div className="text-right w-48">
              <div className="text-sm text-gray-500">Your Score</div>
              <div className="font-bold text-green-600">
                {player === 1 ? gameData.score1 : gameData.score2} / 100
              </div>
              <div className="w-full bg-gray-200 h-3 rounded-full mt-1">
                <div
                  className="bg-green-500 h-3 rounded-full transition-all duration-500"
                  style={{
                    width: `${player === 1 ? gameData.score1 : gameData.score2}%`
                  }}
                ></div>
              </div>
            </div>
          </div>

          {/* Guess Input */}
          <div className="flex gap-2 mb-4">
            <input
              maxLength="4"
              className="border p-2 flex-1 rounded"
              value={guess}
              onChange={e => setGuess(e.target.value)}
              disabled={gameData.winner}
            />
            <button
              className="bg-purple-600 text-white px-4 rounded disabled:bg-gray-400"
              onClick={makeGuess}
              disabled={gameData.turn !== player || gameData.winner}
            >
              Submit
            </button>
          </div>

          {/* Guess Table */}
          <div className="max-h-60 overflow-y-auto border rounded p-2">
            {gameData.guesses.map((g, i) => (
              <div key={i} className="flex justify-between border-b py-1 text-sm">
                <span>Player {g.player} â†’ {g.guess}</span>
                <span>
                  <span className="text-lg font-bold">{g.correctNum}</span>
                  <span className="text-xs"> numbers </span>
                  <span className="text-lg font-bold">{g.correctPos}</span>
                  <span className="text-xs"> places</span>
                </span>
              </div>
            ))}
          </div>

          {/* Winner Window */}
          {gameData.winner && (
            <div className="mt-6 text-center border-t pt-4">
              <div className="text-xl font-bold text-green-700 mb-2">
                {gameData.winner === player ? "You Won!" : "You Lost!"}
              </div>

              <div className="mb-2">
                Opponent Secret: {
                  gameData.winner === 1
                    ? gameData.secret2
                    : gameData.secret1
                }
              </div>

              <button
                className="bg-blue-600 text-white px-4 py-2 rounded"
                onClick={leaveRoom}
              >
                Play Again
              </button>
            </div>
          )}
        </>
      )}

    </div>
  );
}

ReactDOM.render(<App />, document.getElementById("root"));

</script>
</body>
</html>
